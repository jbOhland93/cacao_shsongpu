#!/usr/bin/env bash

# This script uses milk-argparse
# See template milk-scriptexample in module milk_module_example for template and instructions

# script 1-line description
MSdescr="Add Zernike WFS offset"


# Extended description
MSextdescr="Modifies Zernike coefficients in SHM and updates the expanded WFS offset.

The Zernike coefficients are represented as a 1D float stream.
Individual coefficients can be changed using their names.
The expansion is done using the wfs pupil mask.
The output is 1D, but can optionally be reshaped to the pupil mask.
"


source milk-script-std-config
source cacao-check-cacaovars

IM_MASK="aol${CACAO_LOOPNUMBER}_shsCam_RefMask"
ZC_STREAM="aol${CACAO_LOOPNUMBER}_zernCoeff_WFS"
ZE_1D="aol${CACAO_LOOPNUMBER}_zern_WFS"
ZE_2D="${ZE_1D}_reshape"
WFS_OFFSET="unknown"

# prerequisites
#
RequiredCommands=( milk )
RequiredFiles=()
RequiredPipes=()
RequiredDirs=()

# Zernike coefficient names
TiltX="tiltX"
TiltY="tiltY"
Defocus="defoc"
Astig0="astig0"
Astig45="astig45"

# Zernike coefficient indicees
declare -A coeffIndex
coeffIndex["${TiltX}"]=1
coeffIndex["${TiltY}"]=2
coeffIndex["${Defocus}"]=3
coeffIndex["${Astig0}"]=4
coeffIndex["${Astig45}"]=5

# Number of Zernike coefficients
NumZern=11

MSarg+=( "action:string:action (set/setneg/add/sub/check)" )
MSarg+=( "term:string:term (${TiltX}/${TiltY}/${Defocus}/${Astig0}/${Astig45})" )
MSarg+=( "coefficient:float:coefficient" )

# SCRIPT OPTIONS
# syntax: "short:long:functioncall:args[types]:description"
reshape="0"
MSopt+=( "r:reshape:set_reshape::reshape 1D output to 2D mask" )
function set_reshape() {
	reshape="1"
}

source milk-argparse

ACTION="${inputMSargARRAY[0]}"
ZNAME="${inputMSargARRAY[1]}"
CINDEX=-1
if [ -v coeffIndex["${ZNAME}"] ]; then
    CINDEX=${coeffIndex["${ZNAME}"]}
else
    echo "Unknown coefficiont '${ZNAME}'."
    exit 1
fi
echo "Polynome name = ${ZNAME} (index ${CINDEX})"
COEFF=""
# Negative value cannot be passed easily doe to the argument parsing
if [[ ${ACTION} == "setneg" || ${ACTION} == "sub" ]]; then
	# Negate coefficient value if the action requires it
    COEFF="-${inputMSargARRAY[2]}"
else
    COEFF="${inputMSargARRAY[2]}"
fi
echo "Coefficient value = ${COEFF}"
echo "Reshape 2D: ${reshape}"

ACTIONOK=0
if [ ${ACTION} == "check" ]; then
	ACTIONOK=1
fi

# Checking mask
streamcheckOK="OK"
checkstream ${IM_MASK}
if [ ${streamcheckOK} == "FAIL" ]; then
	echo "[$(tput setaf 1)$(tput bold) FAILED $(tput sgr0)] stream check failed"
	cacaomsglog "ERROR streamcheck - WFS mask does not exist"
	exit 1
fi

# Ensuring zernike coefficient image exists
checkstream ${ZC_STREAM}
if [ ${streamcheckOK} == "FAIL" ]; then	
	cacaomsglog "Zernike coefficient stream not existing. Creating stream."
MILK_QUIET=1 milk << EOF
mload milkimagegen
imgen.mkdisk zc_disk ${NumZern} 1 0 0 0
imcpshm zc_disk ${ZC_STREAM}
exit
EOF
    streamcheckOK="OK"
fi

# Set a coefficient
if [[ ${ACTION} == "set" || ${ACTION} == "setneg" ]]; then
	ACTIONOK=1
MILK_QUIET=1 milk << EOF
readshmim ${ZC_STREAM}
setpix ${ZC_STREAM} ${COEFF} ${CINDEX} 0
exit
EOF
fi

# Add to a coefficient
if [[ ${ACTION} == "add" || ${ACTION} == "sub" ]]; then
	ACTIONOK=1
MILK_QUIET=1 milk << EOF
mload milkimagegen
mload milkimagebasic

imgen.mkdisk offset ${NumZern} 1 0 0 0
setpix offset ${COEFF} ${CINDEX} 0
readshmim ${ZC_STREAM}
imgbasic.addim ${ZC_STREAM} offset added_disk 0 0
imcpshm added_disk ${ZC_STREAM}

exit
EOF
fi

if [ ${ACTIONOK} == 0 ]; then
	echo "[$(tput setaf 1)$(tput bold) FAILED $(tput sgr0)] ACTION $ACTION undefined"
	cacaomsglog "ERROR action undefined"
	exit 1
else
	# Everything good, now expand the coefficients
MILK_QUIET=1 milk << EOF
mload cacaoAOloopControlIOtools
readshmim ${IM_MASK}
readshmim ${ZC_STREAM}

cacaoio.zernikeGen .2Doutput ${reshape}

cacaoio.zernikeGen ${ZC_STREAM} ${IM_MASK}

exit
EOF
fi


cacaomsglog "END"
