#!/usr/bin/env bash

# This script uses milk-argparse
# See template milk-scriptexample in module milk_module_example for template and instructions

# script 1-line description
MSdescr="Set up fps for evaluation of a SHS stream on a gpu"

# Extended description
MSextdescr="A script setting up a fps for the evaluation of a SHS stream on a gpu.
The execution of the function requires a reference in shm."

# standard configuration
# location ./scripts/
source milk-script-std-config

# prerequisites
#
RequiredCommands=(milk)
RequiredFiles=(LOOPNUMBER)
RequiredFiles=(LOOPNAME)
RequiredPipes=()
RequiredDirs=()

# SCRIPT MANDATORY ARGUMENTS
# syntax: "name:type(s)/test(s):description"
#
MSarg+=( "refName:string:stream name of the reference" )
MSarg+=( "camName:string:stream name of the shs camera trigger" )

# SCRIPT OPTIONS
# syntax: "short:long:functioncall:args[types]:description"
#

source milk-argparse

set +u
if [ "${EXITSTATUS}" = "1" ]; then
exit
fi
set -u

if [ -f LOOPNUMBER ]; then
    AOLOOPNUMBER=$( head -1 LOOPNUMBER )
else
	echo "Error: no LOOPNUMBER file. Are we running this from the correct directory ?"
    exit
fi
printf "\n"
echo "Loopnumber: ${AOLOOPNUMBER}"

if [ -f LOOPNAME ]; then
    AOLOOPNAME=$( head -1 LOOPNAME )
else
	echo "Error: no LOOPNAME file. Are we running this from the correct directory ?"
    exit
fi
echo "Loopname: ${AOLOOPNAME}"

refstream="${inputMSargARRAY[0]}"
camstream="${inputMSargARRAY[1]}"
echo "Reference stream: ${refstream}"
echo "SHS camera stream: ${camstream}"

MILK_QUIET=1 milk << EOF
mload cacaoAOloopControlIOtools

# Set up process info
cacaoio.shsGpuEval ..procinfo 1
# Set triggermode to 3 (SEMAPHORE) - is triggered by stream update
cacaoio.shsGpuEval ..triggermode 3
# Set triggerstream to input stream
cacaoio.shsGpuEval ..triggersname "${camstream}"
# run indefinitely
cacaoio.shsGpuEval ..loopcntMax -1

# Set input streams
readshmim ${refstream}
cacaoio.shsGpuEval .ref_name ${refstream}
readshmim ${camstream}
cacaoio.shsGpuEval .shscam ${camstream}
readshmim ${camstream}_AVG
cacaoio.shsGpuEval .shsdark ${camstream}_AVG

# Set up other parameters
cacaoio.shsGpuEval .loopnumber ${AOLOOPNUMBER}
cacaoio.shsGpuEval .loopname ${AOLOOPNAME}

# Initialize FPS
cacaoio.shsGpuEval _FPSINIT_ "${camstream}"

exitCLI
EOF
